import { describe, test, expect, beforeEach } from 'vitest';
import { convexTest } from 'convex-test';
import schema from '../../schema';
import { createMockTodoistItem } from '../test_utils/fixtures/items';
import { getActiveItems } from './getActiveItems';

describe('todoist/queries/getActiveItems', () => {
  let t: ReturnType<typeof convexTest>;
  
  beforeEach(() => {
    t = convexTest(schema);
  });

  test('returns only unchecked, non-deleted items', async () => {
    // Setup test data
    await t.run(async (ctx) => {
      await ctx.db.insert('todoist_items', createMockTodoistItem({
        todoist_id: '1',
        content: 'Active task',
        checked: 0,
        is_deleted: 0,
      }));
      
      await ctx.db.insert('todoist_items', createMockTodoistItem({
        todoist_id: '2',
        content: 'Completed task',
        checked: 1,
        is_deleted: 0,
      }));
      
      await ctx.db.insert('todoist_items', createMockTodoistItem({
        todoist_id: '3',
        content: 'Deleted task',
        checked: 0,
        is_deleted: 1,
      }));
    });
    
    // Execute query directly
    const result = await t.run(async (ctx) => {
      return await getActiveItems.handler(ctx, {});
    });
    
    expect(result).toHaveLength(1);
    expect(result[0].content).toBe('Active task');
  });

  test('filters by projectId when provided', async () => {
    // Setup test data
    await t.run(async (ctx) => {
      await ctx.db.insert('todoist_items', createMockTodoistItem({
        todoist_id: '1',
        content: 'Project A task',
        project_id: 'project-a',
        checked: 0,
        is_deleted: 0,
      }));
      
      await ctx.db.insert('todoist_items', createMockTodoistItem({
        todoist_id: '2',
        content: 'Project B task',
        project_id: 'project-b',
        checked: 0,
        is_deleted: 0,
      }));
    });
    
    // Execute query directly with projectId filter
    const result = await t.run(async (ctx) => {
      return await getActiveItems.handler(ctx, { projectId: 'project-a' });
    });
    
    expect(result).toHaveLength(1);
    expect(result[0].content).toBe('Project A task');
  });

  test('orders items by child_order', async () => {
    // Setup test data
    await t.run(async (ctx) => {
      await ctx.db.insert('todoist_items', createMockTodoistItem({
        todoist_id: '1',
        content: 'Third task',
        child_order: 3,
        checked: 0,
        is_deleted: 0,
      }));
      
      await ctx.db.insert('todoist_items', createMockTodoistItem({
        todoist_id: '2',
        content: 'First task',
        child_order: 1,
        checked: 0,
        is_deleted: 0,
      }));
      
      await ctx.db.insert('todoist_items', createMockTodoistItem({
        todoist_id: '3',
        content: 'Second task',
        child_order: 2,
        checked: 0,
        is_deleted: 0,
      }));
    });
    
    // Execute query directly and verify order
    const result = await t.run(async (ctx) => {
      return await getActiveItems.handler(ctx, {});
    });
    
    expect(result).toHaveLength(3);
    expect(result[0].content).toBe('First task');
    expect(result[1].content).toBe('Second task');
    expect(result[2].content).toBe('Third task');
  });
});